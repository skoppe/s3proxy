module crypto;


import s3proxy.crypto;
import unit_threaded;
import std.json;

@("extractPublicKeyFromCert")
unittest {
  extractPublicKeyFromCert("MIIDGTCCAgGgAwIBAgIJIDAsrXnJVoo7MA0GCSqGSIb3DQEBCwUAMCoxKDAmBgNVBAMTH3ZlcmVuaWdpbmdjb2luLWRldi5ldS5hdXRoMC5jb20wHhcNMTcxMjA3MTQxODAyWhcNMzEwODE2MTQxODAyWjAqMSgwJgYDVQQDEx92ZXJlbmlnaW5nY29pbi1kZXYuZXUuYXV0aDAuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzJaQ0Q9C6h/PRa9VlS01doPjNMe+3wSuYMm2HVbIt2Q3TnRIBqFdnPTY2WGMKgaml2vwSp/vaevs0RakP4n40esXizNLVrIAFT84XUt4mvI20pj56X9+l5lkhSEWwY6luT8TkE9fYuCxUMRIhO8J17li0KQN50KjRHteM1VkgleUJGbtjXkkuc91JSFGaE8uAAsY1DH9xjxlkGQ01gqOq8qaQSRIw3JNwbZTkdT5wFLyF4KHZ1Xb496FN30R6TnxJwMyizTHyqCqEJVGL4cKmOzf6lnH7fE1xQW7gYCcXY26AGo3lMFezC8IsFImVSQivwK+1fggj2+gp/jFRzJYUQIDAQABo0IwQDAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBT54964LEw0wKX5mZ3oRn/ibcP2zjAOBgNVHQ8BAf8EBAMCAoQwDQYJKoZIhvcNAQELBQADggEBAHdGR9jHwFRPNB8ISMrxUbxs+oOUo+WPjO64TSeMXjlZWYs0hmSb5dbfPDP6aQpfwT5eChFefjtvGRsBWNwU8YtheGwQ/X53yCIOEZXf0Tb8O6KSpxhV5zlQZxjsReebmrE2jqYqlEYYV65SB+nUkn4IwI/DyKs3V6UA0mEbxZx56HyKnW5eER+yROGp7CsSOJsx0+z5wkgB9a46GwI5A3W5ZTKXKgbm8uN89KvfFppLqmhw3tMSGCTBW37++Z4/tpruUdk8vHEDaJ+ZaasTMEJcP0M/K/uj69+3CWFZ9hWEhagfKK0BwuhiHb/TqdQsKOb5dvccgTsOoSjSMVAQqCk=").shouldEqual("-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzJaQ0Q9C6h/PRa9VlS01
doPjNMe+3wSuYMm2HVbIt2Q3TnRIBqFdnPTY2WGMKgaml2vwSp/vaevs0RakP4n4
0esXizNLVrIAFT84XUt4mvI20pj56X9+l5lkhSEWwY6luT8TkE9fYuCxUMRIhO8J
17li0KQN50KjRHteM1VkgleUJGbtjXkkuc91JSFGaE8uAAsY1DH9xjxlkGQ01gqO
q8qaQSRIw3JNwbZTkdT5wFLyF4KHZ1Xb496FN30R6TnxJwMyizTHyqCqEJVGL4cK
mOzf6lnH7fE1xQW7gYCcXY26AGo3lMFezC8IsFImVSQivwK+1fggj2+gp/jFRzJY
UQIDAQAB
-----END PUBLIC KEY-----
");
}

@("extractPublicKeyFromModulusAndExponent")
@safe unittest {
  extractPublicKeyFromModulusAndExponent("z4P2EC4hwKOwMwb6fpwHa_f-G2w28ucgvGOQqZalzVPNkIuo3y4w46Nlkl8jMPO3vdJt3GAm7TpFD2JCNmcLhhKHiRDEX0i-aYHqPeRi9PGm0moBL7jWL0lLvDpRJiIFE3u2PiuOXb2kQLoxvVa033k8C3nMr2oALnaM8MkXbds3mKBixXOV4oBkVhxXLrZBhtZbJcMfnq0Jwa80pD8krCPCR1DYQprGPmMTjC9bCRaQ_Nlzn6QOuGNLb0YrKEH2pxvoqcgjuU8J-JEVKL4TSgxJEgGxa239WbWHgu7SR_dV7eh9zlb2AMindr1M4o6ADXDpket2agCXPXsgq9XXlk9vHNr1Dnuhop3rJaEKCMvuZEDZCti-rZ_UFdotFVQNHwaJSvCXe3-mk6xGdLpTlRbTqrneonqkpW9lDZDfdzuVk2qQ4apccVzJaoCjN4RdpThrxwfOJYZe_YK37fPp_7ozEvGobtnrtlW697RWzO4IO0h-pq1FX701zTq6wjDbWNoFtAfCj6YID5qH8aFmkTurABLjYAD0cMEIY0AhVDZgcbvT42aD4UTyVqCBWjV5bdnZd6vWexcicA6z1408Wk3pA9nfaGijWnuQ_f7mx8QDJ41tw5do89Cz-eY4OeBGe3VGleEw0BE2A_bAdxEopyjQhj7Yb8c2RLMk8sM0Njc", "AQAB").should == `-----BEGIN PUBLIC KEY-----
MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAz4P2EC4hwKOwMwb6fpwH
a/f+G2w28ucgvGOQqZalzVPNkIuo3y4w46Nlkl8jMPO3vdJt3GAm7TpFD2JCNmcL
hhKHiRDEX0i+aYHqPeRi9PGm0moBL7jWL0lLvDpRJiIFE3u2PiuOXb2kQLoxvVa0
33k8C3nMr2oALnaM8MkXbds3mKBixXOV4oBkVhxXLrZBhtZbJcMfnq0Jwa80pD8k
rCPCR1DYQprGPmMTjC9bCRaQ/Nlzn6QOuGNLb0YrKEH2pxvoqcgjuU8J+JEVKL4T
SgxJEgGxa239WbWHgu7SR/dV7eh9zlb2AMindr1M4o6ADXDpket2agCXPXsgq9XX
lk9vHNr1Dnuhop3rJaEKCMvuZEDZCti+rZ/UFdotFVQNHwaJSvCXe3+mk6xGdLpT
lRbTqrneonqkpW9lDZDfdzuVk2qQ4apccVzJaoCjN4RdpThrxwfOJYZe/YK37fPp
/7ozEvGobtnrtlW697RWzO4IO0h+pq1FX701zTq6wjDbWNoFtAfCj6YID5qH8aFm
kTurABLjYAD0cMEIY0AhVDZgcbvT42aD4UTyVqCBWjV5bdnZd6vWexcicA6z1408
Wk3pA9nfaGijWnuQ/f7mx8QDJ41tw5do89Cz+eY4OeBGe3VGleEw0BE2A/bAdxEo
pyjQhj7Yb8c2RLMk8sM0NjcCAwEAAQ==
-----END PUBLIC KEY-----
`
;
}

@("extractPublicKeyFromXYCoords")
@safe unittest {
  auto x = "MKBCTNIcKUSDii11ySs3526iDZ8AiTo7Tu6KPAqv7D4";
  auto y = "4Etl6SRW2YiLUrN5vfvVHuhp7x8PxltmWWlbbM4IFyM";
  extractPublicKeyFromXYCoords("P-256", x,y).should == "-----BEGIN PUBLIC KEY-----\nMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEMKBCTNIcKUSDii11ySs3526iDZ8A\niTo7Tu6KPAqv7D7gS2XpJFbZiItSs3m9+9Ue6GnvHw/GW2ZZaVtszggXIw==\n-----END PUBLIC KEY-----\n";
}

string testRSAPrivateKey = q"EOS
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAq+e/dME9Mrklp8hvhzqoAq+CWCyOHQrsoMhyuqieTr3QfURt
UY+d9VV0NhfgSRrbzsYGodOV+suo5jr/zi/zTDfEvDFjIVz2HffzTzriQ/q4nF2p
ZqfaS+ctqq6wIa5E05abW4mK6vz1Xnuqi1wu8KfUZjEA5U8Za5MpM4E6P624zMz+
N8C9k6LyNgE3Pr9eU+t7obZNZnQCLBF4g5YxYQ+mpVvPrR5WZhfRCRET3whPC0kR
xy7f1dBxpxq9z6udfUP5S/UyUqlieMeC6Y8+9eag7Df//GhHb8MlUUgAlTXnHhOL
f1lUEqlWWcHxJc9stbgMsPCOlvkurQCV36HOSQIDAQABAoIBAFtk48JUNpAwJVf1
1W3E/qwm2Zq9XXUNaM72oyCgI0Jj4mOnLKOvQmC75QQZX5IeaHyfhcklr9hdzNdS
yMu7bJO6FqujajvDq8o1GDOob8GKm/nuRfEhDotKRlo3c8cEWu1PZhudnbDfeiiY
gQyEnyQtZlxKc1p22mH6JG6QpwJRH5iaxaCcAY+zxXDf1NJcqLtlCQfPycLT8fPW
OFVUrtUnUG8DEm8V8r1oHh6UsCQsrQbB20qWJdiQxr9W2riw6eO/EnK9vsXXqRGz
rXyuaE2zZezgURthgVYiPpe+OrDyeUWdpn1Uoh0PrFzPtLVEjYpMmT5TpBkbhKBS
/4re050CgYEA4JmOwOXg99kedusy5cghsEXI3fN/fUaAj2nfP3rjJaLEiMOSm/mN
8CDGdoOKXmhk7w1up3v2AMAEyKbIdrMAVc/m9GiKNPuiONlHZW/xQGBil9MY84Nh
WUswg0fg70u4OnpfyYnbrnDPt+BpKIO0n5W6TzDs4iFogTlaky5B77cCgYEAw/A/
jZBIxyYUJgext7aoh/WY3d/gHmAyimk0gawQszIQF4248HGPm3ZTL8FoXAMCNFEA
t03sNubIhybS6bHz+gi2P/vNUGGrw3bdXW4geWoaZGwfDmKg0B/q7yOH3MhJ1oSh
mhImyN1QGPp3fctdaax78JnGTm5aXIBAc1d+Mf8CgYBAbq0OV6RHVgkwUl8CnnxT
pmFukvlDBiPBgLzj6Cwb0usQ1RJNHrWCatSkkS3z0X0LO05ATAaRxoRYz8f4jXeO
Jpt6CDeF5Z5vMp4R0qBiOIRwS8X/rfQSesiLEObNn2pVlF/AYIUeMQzWElH4pnf9
xCVzrHR4lt71G3AJgx61VwKBgQCraSDgAkp41kooHvENK+Fx15xc9f6F9Fgil/jU
PCf77B8By/zvdBlSwofxrjxSylsCU57RvXyZZvokqgU3ZnNu2HI/tVQfLuLpw7HS
i4YjUXw3QBNHLWdLy7Bmdmnj7uARp8QMGjcN3/azc2JXjTJyQO/IQ26lrIqmg5he
jzsaFwKBgBLI/WJkvP5IKCSE4zSCOtOMKMMXDEv3lH30O2z4syw2ET0ENAioQDwv
r1c/sFsyUoBwnLmJhwYxuveNBLYYNfgLFsJJvPd1Req+ni47e28qKn2iRG7GZvct
pkIt+dzxyAoauwspxEEiPpGjz91dvBSG9qLcqNQ+BF4X4byB9itQ
-----END RSA PRIVATE KEY-----
EOS";

string testRSAPublicKey = q"EOS
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAq+e/dME9Mrklp8hvhzqo
Aq+CWCyOHQrsoMhyuqieTr3QfURtUY+d9VV0NhfgSRrbzsYGodOV+suo5jr/zi/z
TDfEvDFjIVz2HffzTzriQ/q4nF2pZqfaS+ctqq6wIa5E05abW4mK6vz1Xnuqi1wu
8KfUZjEA5U8Za5MpM4E6P624zMz+N8C9k6LyNgE3Pr9eU+t7obZNZnQCLBF4g5Yx
YQ+mpVvPrR5WZhfRCRET3whPC0kRxy7f1dBxpxq9z6udfUP5S/UyUqlieMeC6Y8+
9eag7Df//GhHb8MlUUgAlTXnHhOLf1lUEqlWWcHxJc9stbgMsPCOlvkurQCV36HO
SQIDAQAB
-----END PUBLIC KEY-----
EOS";
